<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><meta name="next-head-count" content="2"/><link rel="preload" href="/_next/static/css/4bc12c1be68739c7.css" as="style"/><link rel="stylesheet" href="/_next/static/css/4bc12c1be68739c7.css" data-n-g=""/><link rel="preload" href="/_next/static/css/8d58b9228ffac9a6.css" as="style"/><link rel="stylesheet" href="/_next/static/css/8d58b9228ffac9a6.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script src="/_next/static/chunks/webpack-d7b038a63b619762.js" defer=""></script><script src="/_next/static/chunks/framework-91d7f78b5b4003c8.js" defer=""></script><script src="/_next/static/chunks/main-101cfeaa18eb0e64.js" defer=""></script><script src="/_next/static/chunks/pages/_app-5a602b05d6a5b45c.js" defer=""></script><script src="/_next/static/chunks/451-8446afed8f2a81ca.js" defer=""></script><script src="/_next/static/chunks/pages/blog/%5Bid%5D-7b5e07e6b1c54b77.js" defer=""></script><script src="/_next/static/EwuWiZmkeG3lYlO_XC9fM/_buildManifest.js" defer=""></script><script src="/_next/static/EwuWiZmkeG3lYlO_XC9fM/_ssgManifest.js" defer=""></script><script src="/_next/static/EwuWiZmkeG3lYlO_XC9fM/_middlewareManifest.js" defer=""></script></head><body><div id="__next" data-reactroot=""><style data-emotion="css a6by8m">.css-a6by8m{box-sizing:border-box;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-flex-wrap:wrap;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;width:100%;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;margin:auto;}</style><div class="MuiGrid-root MuiGrid-container css-a6by8m"><style data-emotion="css d0aeej">.css-d0aeej{background-color:#FFF;color:#222;margin:30px auto;padding:36px;}.css-d0aeej h1,.css-d0aeej h2,.css-d0aeej h3{font-weight:550;}</style><style data-emotion="css vx8k43">.css-vx8k43{box-sizing:border-box;margin:0;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-flex-basis:91.666667%;-ms-flex-preferred-size:91.666667%;flex-basis:91.666667%;-webkit-box-flex:0;-webkit-flex-grow:0;-ms-flex-positive:0;flex-grow:0;max-width:91.666667%;background-color:#FFF;color:#222;margin:30px auto;padding:36px;}@media (min-width:600px){.css-vx8k43{-webkit-flex-basis:91.666667%;-ms-flex-preferred-size:91.666667%;flex-basis:91.666667%;-webkit-box-flex:0;-webkit-flex-grow:0;-ms-flex-positive:0;flex-grow:0;max-width:91.666667%;}}@media (min-width:900px){.css-vx8k43{-webkit-flex-basis:75%;-ms-flex-preferred-size:75%;flex-basis:75%;-webkit-box-flex:0;-webkit-flex-grow:0;-ms-flex-positive:0;flex-grow:0;max-width:75%;}}@media (min-width:1200px){.css-vx8k43{-webkit-flex-basis:75%;-ms-flex-preferred-size:75%;flex-basis:75%;-webkit-box-flex:0;-webkit-flex-grow:0;-ms-flex-positive:0;flex-grow:0;max-width:75%;}}@media (min-width:1536px){.css-vx8k43{-webkit-flex-basis:75%;-ms-flex-preferred-size:75%;flex-basis:75%;-webkit-box-flex:0;-webkit-flex-grow:0;-ms-flex-positive:0;flex-grow:0;max-width:75%;}}.css-vx8k43 h1,.css-vx8k43 h2,.css-vx8k43 h3{font-weight:550;}</style><div class="MuiGrid-root MuiGrid-item MuiGrid-grid-xs-11 MuiGrid-grid-md-9 css-vx8k43"><style data-emotion="css tph460">.css-tph460{padding:15px 0px;border-bottom:1px solid #4682B4;}</style><div class="css-tph460"><style data-emotion="css 1x4m838">.css-1x4m838{margin:0;font-family:"Roboto","Helvetica","Arial",sans-serif;font-weight:400;font-size:1rem;line-height:1.5;letter-spacing:0.00938em;font-size:26px;font-weight:540;padding-bottom:16px;}</style><p class="MuiTypography-root MuiTypography-body1 css-1x4m838">【Laravel8】Eloquentのupsertメソッドで複数レコードのupdateとinsertをよしなに行う</p><style data-emotion="css q5vujz">.css-q5vujz{margin:0;font-family:"Roboto","Helvetica","Arial",sans-serif;font-weight:400;font-size:0.875rem;line-height:1.43;letter-spacing:0.01071em;display:inline-block;padding-right:32px;}</style><p class="MuiTypography-root MuiTypography-body2 css-q5vujz"><style data-emotion="css 1eipbkb">.css-1eipbkb{-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;width:1em;height:1em;display:inline-block;fill:currentColor;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;-webkit-transition:fill 200ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;transition:fill 200ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;font-size:1.5rem;font-size:15px;margin-right:4px;vertical-align:middle;}</style><svg class="MuiSvgIcon-root MuiSvgIcon-fontSizeMedium css-1eipbkb" focusable="false" aria-hidden="true" viewBox="0 0 24 24" data-testid="AccessTimeIcon"><path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8z"></path><path d="M12.5 7H11v6l5.25 3.15.75-1.23-4.5-2.67z"></path></svg>投稿日 <!-- -->2022/2/16</p><svg class="MuiSvgIcon-root MuiSvgIcon-fontSizeMedium css-1eipbkb" focusable="false" aria-hidden="true" viewBox="0 0 24 24" data-testid="LocalOfferIcon"><path d="m21.41 11.58-9-9C12.05 2.22 11.55 2 11 2H4c-1.1 0-2 .9-2 2v7c0 .55.22 1.05.59 1.42l9 9c.36.36.86.58 1.41.58.55 0 1.05-.22 1.41-.59l7-7c.37-.36.59-.86.59-1.41 0-.55-.23-1.06-.59-1.42zM5.5 7C4.67 7 4 6.33 4 5.5S4.67 4 5.5 4 7 4.67 7 5.5 6.33 7 5.5 7z"></path></svg><style data-emotion="css 1lc4u9f">.css-1lc4u9f{margin:0;font-family:"Roboto","Helvetica","Arial",sans-serif;font-weight:400;font-size:0.875rem;line-height:1.43;letter-spacing:0.01071em;display:inline-block;padding-right:8px;}</style><p class="MuiTypography-root MuiTypography-body2 css-1lc4u9f">#<!-- -->Laravel</p></div><style data-emotion="css il3arz">.css-il3arz{margin-top:40px;}.css-il3arz a{color:#639bb7;}.css-il3arz a:hover{color:#0b7eb8;-webkit-text-decoration:underline;text-decoration:underline;}</style><div class="css-il3arz"><html><head></head><body><p>業務で、複数のデータについて、<br>・既存のデータがDBにあれば更新<br>・既存のデータがDBになければレコード追加<br>を行いたいという場面がありました。<br><br>そこで<code>update</code>か<code>insert</code>のどちらを行うかよしなに判断して<code>Bulk insert</code>を行ってくれるという、すごく便利な<code>Eloquent</code>の<code>upsert</code>メソッドの存在を知ったので、備忘録を書いておきます。<br></p><h2 id="h00bfa7a117">upsertメソッドとは</h2><p>Laravel8から実装された機能で、<strong>1つのクエリで複数のアップサート</strong>を実行できるメソッドです。<br><br><strong>※アップサート（</strong><strong><code>upsert</code></strong><strong>）とは</strong><br>update + insertのことで、データの更新(update)とデータの挿入(insert)の両方の機能を併せ持つ。<br>対象のレコードがあればそのレコードを更新し、レコードがなければレコードの新規追加をするという場合で使う。<br><a href="https://readouble.com/laravel/8.x/ja/eloquent.html#:~:text=%E3%81%A3%E3%81%A6%E3%81%84%E3%82%8B%E5%A0%B4%E5%90%88%E3%80%81-,upsert%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89,-%E3%81%AFcreated_at%E3%81%A8" target="_blank" rel="noopener noreferrer">Eloquentの準備 8.x Laravel</a><a href="unsafe:[object Object]" target="_blank" rel="noopener noreferrer">https://readouble.com</a><br><br>Laravel7までにも<code>updateOrCreate</code>メソッドや<code>firstOrCreate</code>メソッドという一つのレコードをアップサートするメソッドはありましたが、<code>upsert</code>メソッドにより複数レコードを<code>Bulk insert</code>できるようになったようです。<br></p><h2 id="h4d849f4362">使い方</h2><p><code>usersテーブル</code>に複数のデータを<code>upsert</code>する例を書いてみます。<br><br>前提として、DBの<code>usersテーブル</code>には<br><strong>・id：1、name：taro</strong><br><strong>・id：2、name：hanako</strong><br>の2つのレコードが既に存在するとします。<br><br>これに対して以下の通り<code>upsert</code>メソッドを実行します。</p><pre><code class="hljs">User::upsert([
  [<span class="hljs-string">'id'</span> =&gt; <span class="hljs-number">1</span>, <span class="hljs-string">'name'</span> =&gt; <span class="hljs-string">'taro'</span>, <span class="hljs-string">'age'</span> =&gt; <span class="hljs-number">20</span>],      <span class="hljs-comment">// update</span>
  [<span class="hljs-string">'id'</span> =&gt; <span class="hljs-number">2</span>, <span class="hljs-string">'name'</span> =&gt; <span class="hljs-string">'jiro'</span>, <span class="hljs-string">'age'</span> =&gt; <span class="hljs-number">22</span>],      <span class="hljs-comment">// update</span>
  [<span class="hljs-string">'id'</span> =&gt; <span class="hljs-keyword">null</span>, <span class="hljs-string">'name'</span> =&gt; <span class="hljs-string">'taro'</span>, <span class="hljs-string">'age'</span> =&gt; <span class="hljs-number">24</span>]    <span class="hljs-comment">// insert</span>
], [<span class="hljs-string">'id'</span>], [<span class="hljs-string">'name'</span>, <span class="hljs-string">'age'</span>]);</code></pre><p>結果は、第2引数に渡した<code>id</code>が一致するレコードがあった1つ目と2つ目は<code>update</code>となり、3つ目は<code>insert</code>になります。<br></p><h3 id="h997f312e71">構文</h3><p><code>upsert</code>メソッドは3つの引数を持ちます。<br></p><ul><li>第1引数</li></ul><p><code>update</code>または<code>insert</code>を行いたい値を配列で渡す。<br></p><ul><li>第2引数</li></ul><p>レコードを一意に識別するカラム（プライマリーキーかユニークキー）を配列で渡す。<br></p><ul><li>第3引数（省略可）</li></ul><p><code>update</code>が行われる際に、更新する必要があるカラムを配列で渡す。<br>省略すると全カラム更新される。<br></p><h2 id="h86c1eb6dfa">注意点</h2><p>色んな引数を渡して動作確認をしてみて、気を付けるべきと思ったことを挙げておきます。<br></p><h4 id="h93464fb061">第2引数に指定して意味があるのはプライマリーキーもしくはユニークキーのみ</h4><p>上記の例で第2引数に<code>['id', 'name']</code>を渡したとします。<br><br>すると2つ目のデータ<code>['id' =&gt; 2, 'name' =&gt; 'jiro', 'age' =&gt; 22]</code>については、既存のDBのデータは<code>id：2、name：hanako</code>であり<code>name</code>が一致しないので<code>insert</code>になる…と思いきや、<code>update</code>が実行されました。<br><br>Readoubleにも</p><blockquote>2番目の引数は、関連付けられたテーブル内のレコードを一意に識別するカラムをリストします。</blockquote><p>と書いてあるので、第2引数に渡せるのは一意に識別できるカラムに限るようです。<br></p><h4 id="h80576f371d">第2引数には第1引数に渡しているカラムを渡す</h4><p>先ほどの例で、以下のように第1引数には<code>id</code>を渡さず、第2引数に<code>id</code>を渡したとします。</p><pre><code class="hljs">User::upsert([
  [<span class="hljs-string">'name'</span> =&gt; <span class="hljs-string">'taro'</span>, <span class="hljs-string">'age'</span> =&gt; <span class="hljs-number">20</span>],
  [<span class="hljs-string">'name'</span> =&gt; <span class="hljs-string">'jiro'</span>, <span class="hljs-string">'age'</span> =&gt; <span class="hljs-number">22</span>],
  [<span class="hljs-string">'name'</span> =&gt; <span class="hljs-string">'taro'</span>, <span class="hljs-string">'age'</span> =&gt; <span class="hljs-number">24</span>] 
], [<span class="hljs-string">'id'</span>], [<span class="hljs-string">'name'</span>, <span class="hljs-string">'age'</span>]);</code></pre><p><br>この場合は<code>id</code>が一致するカラムがあったとしても全て<code>insert</code>になりました。<br>なので第2引数に指定するカラムは、必ず第1引数にも渡しておかないといけません。<br></p><h2 id="hb95673d4bb">created_atとupdated_atは自動で設定される</h2><p>モデルのタイムスタンプが有効になっている場合、<code>created_at</code>と<code>updated_at</code>のカラムは自動的に値を入れてくれます。<br><br>第1引数には<code>created_at</code>と<code>updated_at</code>について何も書かなくても、</p><ul><li><code>update</code>&nbsp;：<code>updated_at</code>のみ更新</li><li><code>insert</code>&nbsp;：<code>created_at</code>と<code>updated_at</code>は処理をしたときの時刻</li></ul><p>としてくれます。<br><br>普通の&nbsp;<code>insert</code>メソッドを使って<code>bulk insert</code>する場合は、<code>created_at</code>と<code>updated_at</code>は自動入力されず明示的に含める必要があるので、これは便利だなと思いました。<br></p><h2 id="h09ff17952e">【おまけ】実装例</h2><p>実際のコードの書き方の例も残しておきたいと思います。<br><br>これは<code>upsert</code>だけでなく通常の<code>bulk insert</code>にも言えることですが、DBを更新するための配列を<code>foreach</code>や<code>for</code>文を回して作る際は、以下のように書くとスッキリします。</p><pre><code class="hljs"><span class="hljs-comment">// POSTされたデータ配列 $postedAnswers をupsertする場合</span>

<span class="hljs-variable">$upsertAnswers</span> = [];

<span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$postedAnswers</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$answer</span>) {
  <span class="hljs-variable">$upsertAnswers</span> [] = [
    <span class="hljs-string">'id'</span> =&gt; <span class="hljs-variable">$answer</span>[<span class="hljs-string">'id'</span>] ?? <span class="hljs-literal">null</span>,
    <span class="hljs-string">'body'</span> =&gt; <span class="hljs-variable">$answer</span>[<span class="hljs-string">'body'</span>],
    <span class="hljs-string">'type'</span> =&gt; <span class="hljs-variable">$answer</span>[<span class="hljs-string">'type'</span>]
  ];
}

<span class="hljs-comment">// idが一致するレコードがあれば更新、無ければレコード作成する</span>
<span class="hljs-title class_">Answer</span>::<span class="hljs-title function_ invoke__">upsert</span>(<span class="hljs-variable">$upsertSelections</span>, [<span class="hljs-string">'id'</span>]);</code></pre><p><br>私ははじめ<code>array_push</code>を使って配列に要素を追加していっていましたが、先輩にレビューいただいて上記の書き方を知ったのでこれもメモでした！<br></p><h2 id="he45680f0bc">参考記事</h2><p><a href="https://readouble.com/laravel/8.x/ja/eloquent.html#:~:text=%E3%81%A3%E3%81%A6%E3%81%84%E3%82%8B%E5%A0%B4%E5%90%88%E3%80%81-,upsert%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89,-%E3%81%AFcreated_at%E3%81%A8" target="_blank" rel="noopener noreferrer">Eloquentの準備 8.x Laravel</a><a href="unsafe:[object Object]" target="_blank" rel="noopener noreferrer">https://readouble.com</a><br><a href="https://qiita.com/uchiii1/items/bb8043719f15e40db35b#eloquent%E3%81%AEupsert%E3%81%A3%E3%81%A6" target="_blank" rel="noopener noreferrer">【Laravel８】Eloquentのupsert()について - Qiita</a><a href="unsafe:[object Object]" target="_blank" rel="noopener noreferrer">https://qiita.com</a><br><a href="https://zenn.dev/y640/articles/9f66d6abfeecf6#%E4%BD%BF%E3%81%84%E6%96%B9" target="_blank" rel="noopener noreferrer">【Laravel 8】Bulk insertはEloquent::upsertメソッドが便利</a><a href="unsafe:[object Object]" target="_blank" rel="noopener noreferrer">https://zenn.dev</a><br></p></body></html></div></div></div><style data-emotion="css 2sbw87">.css-2sbw87{background-color:#494949;margin:0 auto;padding-top:30px;padding-bottom:30px;color:#f2f2f2;letter-spacing:0.08rem;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:space-around;-ms-flex-pack:space-around;-webkit-justify-content:space-around;justify-content:space-around;-webkit-box-flex-wrap:wrap;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;}</style><div class="css-2sbw87"><style data-emotion="css kta5xp">.css-kta5xp{box-sizing:border-box;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-flex-basis:83.333333%;-ms-flex-preferred-size:83.333333%;flex-basis:83.333333%;-webkit-box-flex:0;-webkit-flex-grow:0;-ms-flex-positive:0;flex-grow:0;max-width:83.333333%;}@media (min-width:600px){.css-kta5xp{-webkit-flex-basis:83.333333%;-ms-flex-preferred-size:83.333333%;flex-basis:83.333333%;-webkit-box-flex:0;-webkit-flex-grow:0;-ms-flex-positive:0;flex-grow:0;max-width:83.333333%;}}@media (min-width:900px){.css-kta5xp{-webkit-flex-basis:66.666667%;-ms-flex-preferred-size:66.666667%;flex-basis:66.666667%;-webkit-box-flex:0;-webkit-flex-grow:0;-ms-flex-positive:0;flex-grow:0;max-width:66.666667%;}}@media (min-width:1200px){.css-kta5xp{-webkit-flex-basis:66.666667%;-ms-flex-preferred-size:66.666667%;flex-basis:66.666667%;-webkit-box-flex:0;-webkit-flex-grow:0;-ms-flex-positive:0;flex-grow:0;max-width:66.666667%;}}@media (min-width:1536px){.css-kta5xp{-webkit-flex-basis:66.666667%;-ms-flex-preferred-size:66.666667%;flex-basis:66.666667%;-webkit-box-flex:0;-webkit-flex-grow:0;-ms-flex-positive:0;flex-grow:0;max-width:66.666667%;}}</style><div class="MuiGrid-root MuiGrid-grid-xs-10 MuiGrid-grid-md-8 css-kta5xp"><style data-emotion="css 1lx0lai">.css-1lx0lai{box-sizing:border-box;margin:0;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;text-align:center;}</style><div class="MuiGrid-root MuiGrid-item css-1lx0lai"><a href="https://twitter.com/napi_nami"><style data-emotion="css 1ea777n">.css-1ea777n{-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;width:1em;height:1em;display:inline-block;fill:currentColor;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;-webkit-transition:fill 200ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;transition:fill 200ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;font-size:1.5rem;margin:8px;}</style><svg class="MuiSvgIcon-root MuiSvgIcon-fontSizeMedium css-1ea777n" focusable="false" aria-hidden="true" viewBox="0 0 24 24" data-testid="TwitterIcon"><path d="M22.46 6c-.77.35-1.6.58-2.46.69.88-.53 1.56-1.37 1.88-2.38-.83.5-1.75.85-2.72 1.05C18.37 4.5 17.26 4 16 4c-2.35 0-4.27 1.92-4.27 4.29 0 .34.04.67.11.98C8.28 9.09 5.11 7.38 3 4.79c-.37.63-.58 1.37-.58 2.15 0 1.49.75 2.81 1.91 3.56-.71 0-1.37-.2-1.95-.5v.03c0 2.08 1.48 3.82 3.44 4.21a4.22 4.22 0 0 1-1.93.07 4.28 4.28 0 0 0 4 2.98 8.521 8.521 0 0 1-5.33 1.84c-.34 0-.68-.02-1.02-.06C3.44 20.29 5.7 21 8.12 21 16 21 20.33 14.46 20.33 8.79c0-.19 0-.37-.01-.56.84-.6 1.56-1.36 2.14-2.23z"></path></svg></a><a href="https://github.com/hinakonagao"><svg class="MuiSvgIcon-root MuiSvgIcon-fontSizeMedium css-1ea777n" focusable="false" aria-hidden="true" viewBox="0 0 24 24" data-testid="GitHubIcon"><path d="M12 1.27a11 11 0 00-3.48 21.46c.55.09.73-.28.73-.55v-1.84c-3.03.64-3.67-1.46-3.67-1.46-.55-1.29-1.28-1.65-1.28-1.65-.92-.65.1-.65.1-.65 1.1 0 1.73 1.1 1.73 1.1.92 1.65 2.57 1.2 3.21.92a2 2 0 01.64-1.47c-2.47-.27-5.04-1.19-5.04-5.5 0-1.1.46-2.1 1.2-2.84a3.76 3.76 0 010-2.93s.91-.28 3.11 1.1c1.8-.49 3.7-.49 5.5 0 2.1-1.38 3.02-1.1 3.02-1.1a3.76 3.76 0 010 2.93c.83.74 1.2 1.74 1.2 2.94 0 4.21-2.57 5.13-5.04 5.4.45.37.82.92.82 2.02v3.03c0 .27.1.64.73.55A11 11 0 0012 1.27"></path></svg></a></div><style data-emotion="css 198jr53">.css-198jr53{margin:0;font-family:"Roboto","Helvetica","Arial",sans-serif;font-weight:400;font-size:0.875rem;line-height:1.43;letter-spacing:0.01071em;text-align:center;font-weight:200;}</style><p class="MuiTypography-root MuiTypography-body2 css-198jr53">© 2022 hinako blog</p></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"blog":{"id":"laravele-upsert","createdAt":"2022-02-17T13:10:20.839Z","updatedAt":"2022-02-17T13:10:54.928Z","publishedAt":"2022-02-16T13:10:20.000Z","revisedAt":"2022-02-17T13:10:44.894Z","title":"【Laravel8】Eloquentのupsertメソッドで複数レコードのupdateとinsertをよしなに行う","body":"\u003cp\u003e業務で、複数のデータについて、\u003cbr\u003e・既存のデータがDBにあれば更新\u003cbr\u003e・既存のデータがDBになければレコード追加\u003cbr\u003eを行いたいという場面がありました。\u003cbr\u003e\u003cbr\u003eそこで\u003ccode\u003eupdate\u003c/code\u003eか\u003ccode\u003einsert\u003c/code\u003eのどちらを行うかよしなに判断して\u003ccode\u003eBulk insert\u003c/code\u003eを行ってくれるという、すごく便利な\u003ccode\u003eEloquent\u003c/code\u003eの\u003ccode\u003eupsert\u003c/code\u003eメソッドの存在を知ったので、備忘録を書いておきます。\u003cbr\u003e\u003c/p\u003e\u003ch2 id=\"h00bfa7a117\"\u003eupsertメソッドとは\u003c/h2\u003e\u003cp\u003eLaravel8から実装された機能で、\u003cstrong\u003e1つのクエリで複数のアップサート\u003c/strong\u003eを実行できるメソッドです。\u003cbr\u003e\u003cbr\u003e\u003cstrong\u003e※アップサート（\u003c/strong\u003e\u003cstrong\u003e\u003ccode\u003eupsert\u003c/code\u003e\u003c/strong\u003e\u003cstrong\u003e）とは\u003c/strong\u003e\u003cbr\u003eupdate + insertのことで、データの更新(update)とデータの挿入(insert)の両方の機能を併せ持つ。\u003cbr\u003e対象のレコードがあればそのレコードを更新し、レコードがなければレコードの新規追加をするという場合で使う。\u003cbr\u003e\u003ca href=\"https://readouble.com/laravel/8.x/ja/eloquent.html#:~:text=%E3%81%A3%E3%81%A6%E3%81%84%E3%82%8B%E5%A0%B4%E5%90%88%E3%80%81-,upsert%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89,-%E3%81%AFcreated_at%E3%81%A8\" target=\"_blank\" rel=\"noopener noreferrer\"\u003eEloquentの準備 8.x Laravel\u003c/a\u003e\u003ca href=\"unsafe:[object Object]\" target=\"_blank\" rel=\"noopener noreferrer\"\u003ehttps://readouble.com\u003c/a\u003e\u003cbr\u003e\u003cbr\u003eLaravel7までにも\u003ccode\u003eupdateOrCreate\u003c/code\u003eメソッドや\u003ccode\u003efirstOrCreate\u003c/code\u003eメソッドという一つのレコードをアップサートするメソッドはありましたが、\u003ccode\u003eupsert\u003c/code\u003eメソッドにより複数レコードを\u003ccode\u003eBulk insert\u003c/code\u003eできるようになったようです。\u003cbr\u003e\u003c/p\u003e\u003ch2 id=\"h4d849f4362\"\u003e使い方\u003c/h2\u003e\u003cp\u003e\u003ccode\u003eusersテーブル\u003c/code\u003eに複数のデータを\u003ccode\u003eupsert\u003c/code\u003eする例を書いてみます。\u003cbr\u003e\u003cbr\u003e前提として、DBの\u003ccode\u003eusersテーブル\u003c/code\u003eには\u003cbr\u003e\u003cstrong\u003e・id：1、name：taro\u003c/strong\u003e\u003cbr\u003e\u003cstrong\u003e・id：2、name：hanako\u003c/strong\u003e\u003cbr\u003eの2つのレコードが既に存在するとします。\u003cbr\u003e\u003cbr\u003eこれに対して以下の通り\u003ccode\u003eupsert\u003c/code\u003eメソッドを実行します。\u003c/p\u003e\u003cpre\u003e\u003ccode\u003eUser::upsert([\n  ['id' =\u0026gt; 1, 'name' =\u0026gt; 'taro', 'age' =\u0026gt; 20],      // update\n  ['id' =\u0026gt; 2, 'name' =\u0026gt; 'jiro', 'age' =\u0026gt; 22],      // update\n  ['id' =\u0026gt; null, 'name' =\u0026gt; 'taro', 'age' =\u0026gt; 24]    // insert\n], ['id'], ['name', 'age']);\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e結果は、第2引数に渡した\u003ccode\u003eid\u003c/code\u003eが一致するレコードがあった1つ目と2つ目は\u003ccode\u003eupdate\u003c/code\u003eとなり、3つ目は\u003ccode\u003einsert\u003c/code\u003eになります。\u003cbr\u003e\u003c/p\u003e\u003ch3 id=\"h997f312e71\"\u003e構文\u003c/h3\u003e\u003cp\u003e\u003ccode\u003eupsert\u003c/code\u003eメソッドは3つの引数を持ちます。\u003cbr\u003e\u003c/p\u003e\u003cul\u003e\u003cli\u003e第1引数\u003c/li\u003e\u003c/ul\u003e\u003cp\u003e\u003ccode\u003eupdate\u003c/code\u003eまたは\u003ccode\u003einsert\u003c/code\u003eを行いたい値を配列で渡す。\u003cbr\u003e\u003c/p\u003e\u003cul\u003e\u003cli\u003e第2引数\u003c/li\u003e\u003c/ul\u003e\u003cp\u003eレコードを一意に識別するカラム（プライマリーキーかユニークキー）を配列で渡す。\u003cbr\u003e\u003c/p\u003e\u003cul\u003e\u003cli\u003e第3引数（省略可）\u003c/li\u003e\u003c/ul\u003e\u003cp\u003e\u003ccode\u003eupdate\u003c/code\u003eが行われる際に、更新する必要があるカラムを配列で渡す。\u003cbr\u003e省略すると全カラム更新される。\u003cbr\u003e\u003c/p\u003e\u003ch2 id=\"h86c1eb6dfa\"\u003e注意点\u003c/h2\u003e\u003cp\u003e色んな引数を渡して動作確認をしてみて、気を付けるべきと思ったことを挙げておきます。\u003cbr\u003e\u003c/p\u003e\u003ch4 id=\"h93464fb061\"\u003e第2引数に指定して意味があるのはプライマリーキーもしくはユニークキーのみ\u003c/h4\u003e\u003cp\u003e上記の例で第2引数に\u003ccode\u003e['id', 'name']\u003c/code\u003eを渡したとします。\u003cbr\u003e\u003cbr\u003eすると2つ目のデータ\u003ccode\u003e['id' =\u0026gt; 2, 'name' =\u0026gt; 'jiro', 'age' =\u0026gt; 22]\u003c/code\u003eについては、既存のDBのデータは\u003ccode\u003eid：2、name：hanako\u003c/code\u003eであり\u003ccode\u003ename\u003c/code\u003eが一致しないので\u003ccode\u003einsert\u003c/code\u003eになる…と思いきや、\u003ccode\u003eupdate\u003c/code\u003eが実行されました。\u003cbr\u003e\u003cbr\u003eReadoubleにも\u003c/p\u003e\u003cblockquote\u003e2番目の引数は、関連付けられたテーブル内のレコードを一意に識別するカラムをリストします。\u003c/blockquote\u003e\u003cp\u003eと書いてあるので、第2引数に渡せるのは一意に識別できるカラムに限るようです。\u003cbr\u003e\u003c/p\u003e\u003ch4 id=\"h80576f371d\"\u003e第2引数には第1引数に渡しているカラムを渡す\u003c/h4\u003e\u003cp\u003e先ほどの例で、以下のように第1引数には\u003ccode\u003eid\u003c/code\u003eを渡さず、第2引数に\u003ccode\u003eid\u003c/code\u003eを渡したとします。\u003c/p\u003e\u003cpre\u003e\u003ccode\u003eUser::upsert([\n  ['name' =\u0026gt; 'taro', 'age' =\u0026gt; 20],\n  ['name' =\u0026gt; 'jiro', 'age' =\u0026gt; 22],\n  ['name' =\u0026gt; 'taro', 'age' =\u0026gt; 24] \n], ['id'], ['name', 'age']);\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003eこの場合は\u003ccode\u003eid\u003c/code\u003eが一致するカラムがあったとしても全て\u003ccode\u003einsert\u003c/code\u003eになりました。\u003cbr\u003eなので第2引数に指定するカラムは、必ず第1引数にも渡しておかないといけません。\u003cbr\u003e\u003c/p\u003e\u003ch2 id=\"hb95673d4bb\"\u003ecreated_atとupdated_atは自動で設定される\u003c/h2\u003e\u003cp\u003eモデルのタイムスタンプが有効になっている場合、\u003ccode\u003ecreated_at\u003c/code\u003eと\u003ccode\u003eupdated_at\u003c/code\u003eのカラムは自動的に値を入れてくれます。\u003cbr\u003e\u003cbr\u003e第1引数には\u003ccode\u003ecreated_at\u003c/code\u003eと\u003ccode\u003eupdated_at\u003c/code\u003eについて何も書かなくても、\u003c/p\u003e\u003cul\u003e\u003cli\u003e\u003ccode\u003eupdate\u003c/code\u003e\u0026nbsp;：\u003ccode\u003eupdated_at\u003c/code\u003eのみ更新\u003c/li\u003e\u003cli\u003e\u003ccode\u003einsert\u003c/code\u003e\u0026nbsp;：\u003ccode\u003ecreated_at\u003c/code\u003eと\u003ccode\u003eupdated_at\u003c/code\u003eは処理をしたときの時刻\u003c/li\u003e\u003c/ul\u003e\u003cp\u003eとしてくれます。\u003cbr\u003e\u003cbr\u003e普通の\u0026nbsp;\u003ccode\u003einsert\u003c/code\u003eメソッドを使って\u003ccode\u003ebulk insert\u003c/code\u003eする場合は、\u003ccode\u003ecreated_at\u003c/code\u003eと\u003ccode\u003eupdated_at\u003c/code\u003eは自動入力されず明示的に含める必要があるので、これは便利だなと思いました。\u003cbr\u003e\u003c/p\u003e\u003ch2 id=\"h09ff17952e\"\u003e【おまけ】実装例\u003c/h2\u003e\u003cp\u003e実際のコードの書き方の例も残しておきたいと思います。\u003cbr\u003e\u003cbr\u003eこれは\u003ccode\u003eupsert\u003c/code\u003eだけでなく通常の\u003ccode\u003ebulk insert\u003c/code\u003eにも言えることですが、DBを更新するための配列を\u003ccode\u003eforeach\u003c/code\u003eや\u003ccode\u003efor\u003c/code\u003e文を回して作る際は、以下のように書くとスッキリします。\u003c/p\u003e\u003cpre\u003e\u003ccode\u003e// POSTされたデータ配列 $postedAnswers をupsertする場合\n\n$upsertAnswers = [];\n\nforeach ($postedAnswers as $answer) {\n  $upsertAnswers [] = [\n    'id' =\u0026gt; $answer['id'] ?? null,\n    'body' =\u0026gt; $answer['body'],\n    'type' =\u0026gt; $answer['type']\n  ];\n}\n\n// idが一致するレコードがあれば更新、無ければレコード作成する\nAnswer::upsert($upsertSelections, ['id']);\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003e私ははじめ\u003ccode\u003earray_push\u003c/code\u003eを使って配列に要素を追加していっていましたが、先輩にレビューいただいて上記の書き方を知ったのでこれもメモでした！\u003cbr\u003e\u003c/p\u003e\u003ch2 id=\"he45680f0bc\"\u003e参考記事\u003c/h2\u003e\u003cp\u003e\u003ca href=\"https://readouble.com/laravel/8.x/ja/eloquent.html#:~:text=%E3%81%A3%E3%81%A6%E3%81%84%E3%82%8B%E5%A0%B4%E5%90%88%E3%80%81-,upsert%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89,-%E3%81%AFcreated_at%E3%81%A8\" target=\"_blank\" rel=\"noopener noreferrer\"\u003eEloquentの準備 8.x Laravel\u003c/a\u003e\u003ca href=\"unsafe:[object Object]\" target=\"_blank\" rel=\"noopener noreferrer\"\u003ehttps://readouble.com\u003c/a\u003e\u003cbr\u003e\u003ca href=\"https://qiita.com/uchiii1/items/bb8043719f15e40db35b#eloquent%E3%81%AEupsert%E3%81%A3%E3%81%A6\" target=\"_blank\" rel=\"noopener noreferrer\"\u003e【Laravel８】Eloquentのupsert()について - Qiita\u003c/a\u003e\u003ca href=\"unsafe:[object Object]\" target=\"_blank\" rel=\"noopener noreferrer\"\u003ehttps://qiita.com\u003c/a\u003e\u003cbr\u003e\u003ca href=\"https://zenn.dev/y640/articles/9f66d6abfeecf6#%E4%BD%BF%E3%81%84%E6%96%B9\" target=\"_blank\" rel=\"noopener noreferrer\"\u003e【Laravel 8】Bulk insertはEloquent::upsertメソッドが便利\u003c/a\u003e\u003ca href=\"unsafe:[object Object]\" target=\"_blank\" rel=\"noopener noreferrer\"\u003ehttps://zenn.dev\u003c/a\u003e\u003cbr\u003e\u003c/p\u003e","tags":[{"id":"laravel","createdAt":"2022-01-07T13:17:32.553Z","updatedAt":"2022-02-12T02:31:33.697Z","publishedAt":"2022-01-07T13:17:32.553Z","revisedAt":"2022-01-07T13:17:38.700Z","tag":"Laravel"}],"image":"laravel"},"highlightedBody":"\u003chtml\u003e\u003chead\u003e\u003c/head\u003e\u003cbody\u003e\u003cp\u003e業務で、複数のデータについて、\u003cbr\u003e・既存のデータがDBにあれば更新\u003cbr\u003e・既存のデータがDBになければレコード追加\u003cbr\u003eを行いたいという場面がありました。\u003cbr\u003e\u003cbr\u003eそこで\u003ccode\u003eupdate\u003c/code\u003eか\u003ccode\u003einsert\u003c/code\u003eのどちらを行うかよしなに判断して\u003ccode\u003eBulk insert\u003c/code\u003eを行ってくれるという、すごく便利な\u003ccode\u003eEloquent\u003c/code\u003eの\u003ccode\u003eupsert\u003c/code\u003eメソッドの存在を知ったので、備忘録を書いておきます。\u003cbr\u003e\u003c/p\u003e\u003ch2 id=\"h00bfa7a117\"\u003eupsertメソッドとは\u003c/h2\u003e\u003cp\u003eLaravel8から実装された機能で、\u003cstrong\u003e1つのクエリで複数のアップサート\u003c/strong\u003eを実行できるメソッドです。\u003cbr\u003e\u003cbr\u003e\u003cstrong\u003e※アップサート（\u003c/strong\u003e\u003cstrong\u003e\u003ccode\u003eupsert\u003c/code\u003e\u003c/strong\u003e\u003cstrong\u003e）とは\u003c/strong\u003e\u003cbr\u003eupdate + insertのことで、データの更新(update)とデータの挿入(insert)の両方の機能を併せ持つ。\u003cbr\u003e対象のレコードがあればそのレコードを更新し、レコードがなければレコードの新規追加をするという場合で使う。\u003cbr\u003e\u003ca href=\"https://readouble.com/laravel/8.x/ja/eloquent.html#:~:text=%E3%81%A3%E3%81%A6%E3%81%84%E3%82%8B%E5%A0%B4%E5%90%88%E3%80%81-,upsert%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89,-%E3%81%AFcreated_at%E3%81%A8\" target=\"_blank\" rel=\"noopener noreferrer\"\u003eEloquentの準備 8.x Laravel\u003c/a\u003e\u003ca href=\"unsafe:[object Object]\" target=\"_blank\" rel=\"noopener noreferrer\"\u003ehttps://readouble.com\u003c/a\u003e\u003cbr\u003e\u003cbr\u003eLaravel7までにも\u003ccode\u003eupdateOrCreate\u003c/code\u003eメソッドや\u003ccode\u003efirstOrCreate\u003c/code\u003eメソッドという一つのレコードをアップサートするメソッドはありましたが、\u003ccode\u003eupsert\u003c/code\u003eメソッドにより複数レコードを\u003ccode\u003eBulk insert\u003c/code\u003eできるようになったようです。\u003cbr\u003e\u003c/p\u003e\u003ch2 id=\"h4d849f4362\"\u003e使い方\u003c/h2\u003e\u003cp\u003e\u003ccode\u003eusersテーブル\u003c/code\u003eに複数のデータを\u003ccode\u003eupsert\u003c/code\u003eする例を書いてみます。\u003cbr\u003e\u003cbr\u003e前提として、DBの\u003ccode\u003eusersテーブル\u003c/code\u003eには\u003cbr\u003e\u003cstrong\u003e・id：1、name：taro\u003c/strong\u003e\u003cbr\u003e\u003cstrong\u003e・id：2、name：hanako\u003c/strong\u003e\u003cbr\u003eの2つのレコードが既に存在するとします。\u003cbr\u003e\u003cbr\u003eこれに対して以下の通り\u003ccode\u003eupsert\u003c/code\u003eメソッドを実行します。\u003c/p\u003e\u003cpre\u003e\u003ccode class=\"hljs\"\u003eUser::upsert([\n  [\u003cspan class=\"hljs-string\"\u003e'id'\u003c/span\u003e =\u0026gt; \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e'name'\u003c/span\u003e =\u0026gt; \u003cspan class=\"hljs-string\"\u003e'taro'\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e'age'\u003c/span\u003e =\u0026gt; \u003cspan class=\"hljs-number\"\u003e20\u003c/span\u003e],      \u003cspan class=\"hljs-comment\"\u003e// update\u003c/span\u003e\n  [\u003cspan class=\"hljs-string\"\u003e'id'\u003c/span\u003e =\u0026gt; \u003cspan class=\"hljs-number\"\u003e2\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e'name'\u003c/span\u003e =\u0026gt; \u003cspan class=\"hljs-string\"\u003e'jiro'\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e'age'\u003c/span\u003e =\u0026gt; \u003cspan class=\"hljs-number\"\u003e22\u003c/span\u003e],      \u003cspan class=\"hljs-comment\"\u003e// update\u003c/span\u003e\n  [\u003cspan class=\"hljs-string\"\u003e'id'\u003c/span\u003e =\u0026gt; \u003cspan class=\"hljs-keyword\"\u003enull\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e'name'\u003c/span\u003e =\u0026gt; \u003cspan class=\"hljs-string\"\u003e'taro'\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e'age'\u003c/span\u003e =\u0026gt; \u003cspan class=\"hljs-number\"\u003e24\u003c/span\u003e]    \u003cspan class=\"hljs-comment\"\u003e// insert\u003c/span\u003e\n], [\u003cspan class=\"hljs-string\"\u003e'id'\u003c/span\u003e], [\u003cspan class=\"hljs-string\"\u003e'name'\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e'age'\u003c/span\u003e]);\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e結果は、第2引数に渡した\u003ccode\u003eid\u003c/code\u003eが一致するレコードがあった1つ目と2つ目は\u003ccode\u003eupdate\u003c/code\u003eとなり、3つ目は\u003ccode\u003einsert\u003c/code\u003eになります。\u003cbr\u003e\u003c/p\u003e\u003ch3 id=\"h997f312e71\"\u003e構文\u003c/h3\u003e\u003cp\u003e\u003ccode\u003eupsert\u003c/code\u003eメソッドは3つの引数を持ちます。\u003cbr\u003e\u003c/p\u003e\u003cul\u003e\u003cli\u003e第1引数\u003c/li\u003e\u003c/ul\u003e\u003cp\u003e\u003ccode\u003eupdate\u003c/code\u003eまたは\u003ccode\u003einsert\u003c/code\u003eを行いたい値を配列で渡す。\u003cbr\u003e\u003c/p\u003e\u003cul\u003e\u003cli\u003e第2引数\u003c/li\u003e\u003c/ul\u003e\u003cp\u003eレコードを一意に識別するカラム（プライマリーキーかユニークキー）を配列で渡す。\u003cbr\u003e\u003c/p\u003e\u003cul\u003e\u003cli\u003e第3引数（省略可）\u003c/li\u003e\u003c/ul\u003e\u003cp\u003e\u003ccode\u003eupdate\u003c/code\u003eが行われる際に、更新する必要があるカラムを配列で渡す。\u003cbr\u003e省略すると全カラム更新される。\u003cbr\u003e\u003c/p\u003e\u003ch2 id=\"h86c1eb6dfa\"\u003e注意点\u003c/h2\u003e\u003cp\u003e色んな引数を渡して動作確認をしてみて、気を付けるべきと思ったことを挙げておきます。\u003cbr\u003e\u003c/p\u003e\u003ch4 id=\"h93464fb061\"\u003e第2引数に指定して意味があるのはプライマリーキーもしくはユニークキーのみ\u003c/h4\u003e\u003cp\u003e上記の例で第2引数に\u003ccode\u003e['id', 'name']\u003c/code\u003eを渡したとします。\u003cbr\u003e\u003cbr\u003eすると2つ目のデータ\u003ccode\u003e['id' =\u0026gt; 2, 'name' =\u0026gt; 'jiro', 'age' =\u0026gt; 22]\u003c/code\u003eについては、既存のDBのデータは\u003ccode\u003eid：2、name：hanako\u003c/code\u003eであり\u003ccode\u003ename\u003c/code\u003eが一致しないので\u003ccode\u003einsert\u003c/code\u003eになる…と思いきや、\u003ccode\u003eupdate\u003c/code\u003eが実行されました。\u003cbr\u003e\u003cbr\u003eReadoubleにも\u003c/p\u003e\u003cblockquote\u003e2番目の引数は、関連付けられたテーブル内のレコードを一意に識別するカラムをリストします。\u003c/blockquote\u003e\u003cp\u003eと書いてあるので、第2引数に渡せるのは一意に識別できるカラムに限るようです。\u003cbr\u003e\u003c/p\u003e\u003ch4 id=\"h80576f371d\"\u003e第2引数には第1引数に渡しているカラムを渡す\u003c/h4\u003e\u003cp\u003e先ほどの例で、以下のように第1引数には\u003ccode\u003eid\u003c/code\u003eを渡さず、第2引数に\u003ccode\u003eid\u003c/code\u003eを渡したとします。\u003c/p\u003e\u003cpre\u003e\u003ccode class=\"hljs\"\u003eUser::upsert([\n  [\u003cspan class=\"hljs-string\"\u003e'name'\u003c/span\u003e =\u0026gt; \u003cspan class=\"hljs-string\"\u003e'taro'\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e'age'\u003c/span\u003e =\u0026gt; \u003cspan class=\"hljs-number\"\u003e20\u003c/span\u003e],\n  [\u003cspan class=\"hljs-string\"\u003e'name'\u003c/span\u003e =\u0026gt; \u003cspan class=\"hljs-string\"\u003e'jiro'\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e'age'\u003c/span\u003e =\u0026gt; \u003cspan class=\"hljs-number\"\u003e22\u003c/span\u003e],\n  [\u003cspan class=\"hljs-string\"\u003e'name'\u003c/span\u003e =\u0026gt; \u003cspan class=\"hljs-string\"\u003e'taro'\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e'age'\u003c/span\u003e =\u0026gt; \u003cspan class=\"hljs-number\"\u003e24\u003c/span\u003e] \n], [\u003cspan class=\"hljs-string\"\u003e'id'\u003c/span\u003e], [\u003cspan class=\"hljs-string\"\u003e'name'\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e'age'\u003c/span\u003e]);\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003eこの場合は\u003ccode\u003eid\u003c/code\u003eが一致するカラムがあったとしても全て\u003ccode\u003einsert\u003c/code\u003eになりました。\u003cbr\u003eなので第2引数に指定するカラムは、必ず第1引数にも渡しておかないといけません。\u003cbr\u003e\u003c/p\u003e\u003ch2 id=\"hb95673d4bb\"\u003ecreated_atとupdated_atは自動で設定される\u003c/h2\u003e\u003cp\u003eモデルのタイムスタンプが有効になっている場合、\u003ccode\u003ecreated_at\u003c/code\u003eと\u003ccode\u003eupdated_at\u003c/code\u003eのカラムは自動的に値を入れてくれます。\u003cbr\u003e\u003cbr\u003e第1引数には\u003ccode\u003ecreated_at\u003c/code\u003eと\u003ccode\u003eupdated_at\u003c/code\u003eについて何も書かなくても、\u003c/p\u003e\u003cul\u003e\u003cli\u003e\u003ccode\u003eupdate\u003c/code\u003e\u0026nbsp;：\u003ccode\u003eupdated_at\u003c/code\u003eのみ更新\u003c/li\u003e\u003cli\u003e\u003ccode\u003einsert\u003c/code\u003e\u0026nbsp;：\u003ccode\u003ecreated_at\u003c/code\u003eと\u003ccode\u003eupdated_at\u003c/code\u003eは処理をしたときの時刻\u003c/li\u003e\u003c/ul\u003e\u003cp\u003eとしてくれます。\u003cbr\u003e\u003cbr\u003e普通の\u0026nbsp;\u003ccode\u003einsert\u003c/code\u003eメソッドを使って\u003ccode\u003ebulk insert\u003c/code\u003eする場合は、\u003ccode\u003ecreated_at\u003c/code\u003eと\u003ccode\u003eupdated_at\u003c/code\u003eは自動入力されず明示的に含める必要があるので、これは便利だなと思いました。\u003cbr\u003e\u003c/p\u003e\u003ch2 id=\"h09ff17952e\"\u003e【おまけ】実装例\u003c/h2\u003e\u003cp\u003e実際のコードの書き方の例も残しておきたいと思います。\u003cbr\u003e\u003cbr\u003eこれは\u003ccode\u003eupsert\u003c/code\u003eだけでなく通常の\u003ccode\u003ebulk insert\u003c/code\u003eにも言えることですが、DBを更新するための配列を\u003ccode\u003eforeach\u003c/code\u003eや\u003ccode\u003efor\u003c/code\u003e文を回して作る際は、以下のように書くとスッキリします。\u003c/p\u003e\u003cpre\u003e\u003ccode class=\"hljs\"\u003e\u003cspan class=\"hljs-comment\"\u003e// POSTされたデータ配列 $postedAnswers をupsertする場合\u003c/span\u003e\n\n\u003cspan class=\"hljs-variable\"\u003e$upsertAnswers\u003c/span\u003e = [];\n\n\u003cspan class=\"hljs-keyword\"\u003eforeach\u003c/span\u003e (\u003cspan class=\"hljs-variable\"\u003e$postedAnswers\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eas\u003c/span\u003e \u003cspan class=\"hljs-variable\"\u003e$answer\u003c/span\u003e) {\n  \u003cspan class=\"hljs-variable\"\u003e$upsertAnswers\u003c/span\u003e [] = [\n    \u003cspan class=\"hljs-string\"\u003e'id'\u003c/span\u003e =\u0026gt; \u003cspan class=\"hljs-variable\"\u003e$answer\u003c/span\u003e[\u003cspan class=\"hljs-string\"\u003e'id'\u003c/span\u003e] ?? \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e,\n    \u003cspan class=\"hljs-string\"\u003e'body'\u003c/span\u003e =\u0026gt; \u003cspan class=\"hljs-variable\"\u003e$answer\u003c/span\u003e[\u003cspan class=\"hljs-string\"\u003e'body'\u003c/span\u003e],\n    \u003cspan class=\"hljs-string\"\u003e'type'\u003c/span\u003e =\u0026gt; \u003cspan class=\"hljs-variable\"\u003e$answer\u003c/span\u003e[\u003cspan class=\"hljs-string\"\u003e'type'\u003c/span\u003e]\n  ];\n}\n\n\u003cspan class=\"hljs-comment\"\u003e// idが一致するレコードがあれば更新、無ければレコード作成する\u003c/span\u003e\n\u003cspan class=\"hljs-title class_\"\u003eAnswer\u003c/span\u003e::\u003cspan class=\"hljs-title function_ invoke__\"\u003eupsert\u003c/span\u003e(\u003cspan class=\"hljs-variable\"\u003e$upsertSelections\u003c/span\u003e, [\u003cspan class=\"hljs-string\"\u003e'id'\u003c/span\u003e]);\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003e私ははじめ\u003ccode\u003earray_push\u003c/code\u003eを使って配列に要素を追加していっていましたが、先輩にレビューいただいて上記の書き方を知ったのでこれもメモでした！\u003cbr\u003e\u003c/p\u003e\u003ch2 id=\"he45680f0bc\"\u003e参考記事\u003c/h2\u003e\u003cp\u003e\u003ca href=\"https://readouble.com/laravel/8.x/ja/eloquent.html#:~:text=%E3%81%A3%E3%81%A6%E3%81%84%E3%82%8B%E5%A0%B4%E5%90%88%E3%80%81-,upsert%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89,-%E3%81%AFcreated_at%E3%81%A8\" target=\"_blank\" rel=\"noopener noreferrer\"\u003eEloquentの準備 8.x Laravel\u003c/a\u003e\u003ca href=\"unsafe:[object Object]\" target=\"_blank\" rel=\"noopener noreferrer\"\u003ehttps://readouble.com\u003c/a\u003e\u003cbr\u003e\u003ca href=\"https://qiita.com/uchiii1/items/bb8043719f15e40db35b#eloquent%E3%81%AEupsert%E3%81%A3%E3%81%A6\" target=\"_blank\" rel=\"noopener noreferrer\"\u003e【Laravel８】Eloquentのupsert()について - Qiita\u003c/a\u003e\u003ca href=\"unsafe:[object Object]\" target=\"_blank\" rel=\"noopener noreferrer\"\u003ehttps://qiita.com\u003c/a\u003e\u003cbr\u003e\u003ca href=\"https://zenn.dev/y640/articles/9f66d6abfeecf6#%E4%BD%BF%E3%81%84%E6%96%B9\" target=\"_blank\" rel=\"noopener noreferrer\"\u003e【Laravel 8】Bulk insertはEloquent::upsertメソッドが便利\u003c/a\u003e\u003ca href=\"unsafe:[object Object]\" target=\"_blank\" rel=\"noopener noreferrer\"\u003ehttps://zenn.dev\u003c/a\u003e\u003cbr\u003e\u003c/p\u003e\u003c/body\u003e\u003c/html\u003e"},"__N_SSG":true},"page":"/blog/[id]","query":{"id":"laravele-upsert"},"buildId":"EwuWiZmkeG3lYlO_XC9fM","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>